# "org" ensures this Service is used with the correct Serverless Framework Access Key.
org: lpilas
# "app" enables Serverless Framework Dashboard features and sharing them with other Services.
app: serverless-appointment-system
# "service" is the name of this project. This will also be added to your AWS resource names.
service: serverless-appointment-system

frameworkVersion: "4"

provider:
  name: aws
  runtime: nodejs20.x
  region: us-east-1

resources:
  Resources:
    AppointmentsTable: #Declaración de la tabla en DynamoDB
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: AppointmentsTable
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: insuredId
            AttributeType: S
        BillingMode: PAY_PER_REQUEST

        GlobalSecondaryIndexes: # se define para permitir consultas que no usan la llave principal
          - IndexName: InsuredIdIndex # El índice secundario global para la consulta de listado
            KeySchema:
              - AttributeName: insuredId
                KeyType: HASH # Clave de Partición para el GSI
            Projection:
              ProjectionType: ALL # Proyecta todos los atributos para que el listado sea completo
    AppointmentsTopic: #Declaración del tópico en SNS
      Type: AWS::SNS::Topic
      Properties:
        TopicName: AppointmentsTopic

    SqsPe: #Cola de mensajes para Perú
      Type: AWS::SQS::Queue
      Properties:
        QueueName: AppointmentsPeQueue
        MessageRetentionPeriod: 1209600 # 14 días en segundos

    SqsCl: #Cola de mensajes para Chile
      Type: AWS::SQS::Queue
      Properties:
        QueueName: AppointmentsClQueue
        MessageRetentionPeriod: 1209600 # 14 días en segundos

    SqsPeSubscription: # Suscripción de la cola de Perú al tópico con filtro
      Type: AWS::SNS::Subscription
      Properties:
        Protocol: sqs
        Endpoint: !GetAtt SqsPe.Arn
        TopicArn: !Ref AppointmentsTopic
        FilterPolicy: # Solo acepta mensajes con countryISO: "PE"
          countryISO:
            - "PE"

    SqsClSubscription: # Suscripción de la cola de Chile al tópico con filtro
      Type: AWS::SNS::Subscription
      Properties:
        Protocol: sqs
        Endpoint: !GetAtt SqsCl.Arn
        TopicArn: !Ref AppointmentsTopic
        FilterPolicy: # Solo acepta mensajes con countryISO: "CL"
          countryISO:
            - "CL"

    SqsReturn: #Cola de mensajes para retornos
      Type: AWS::SQS::Queue
      Properties:
        QueueName: AppointmentsReturnQueue
        MessageRetentionPeriod: 1209600 # 14 días en segundos

    AppointmentCompletionRule: # Regla de EventBridge para completar citas
      Type: AWS::Events::Rule
      Properties:
        Name: AppointmentCompletionRule
        EventBusName: default # Usamos el bus de eventos por defecto de AWS
        EventPattern: # El patrón de evento que estaremos escuchando
          source:
            - "appointment.service" # El servicio que emite el evento
          detail-type:
            - "AppointmentCompleted" # El tipo de evento
        Targets:
          - Arn: !GetAtt SqsReturn.Arn # El destino es el ARN de la cola de retorno
            Id: SqsReturnTarget

    SqsReturnPolicy: # política SQS para permitir que EventBridge escriba en la cola
      Type: AWS::SQS::QueuePolicy
      Properties:
        Queues:
          - !Ref SqsReturn
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal:
                Service: events.amazonaws.com # Permite a EventBridge enviar mensajes
              Action: SQS:SendMessage
              Resource: !GetAtt SqsReturn.Arn
              Condition:
                ArnEquals:
                  aws:SourceArn: !GetAtt AppointmentCompletionRule.Arn
  Outputs:
    #permite que se pueda referenciar al nombre de estos elementos desde funciones lambda, event bridge, etc
    SqsPeArn:
      #obtiene el Arn del recurso
      Value: !GetAtt SqsPe.Arn
      #hace que el Arn sea publico dentro de nuestra cuenta AWS bajo el nombre especificado
      Export:
        Name: ${self:service}-SqsPeArn

    SqsClArn:
      Value: !GetAtt SqsCl.Arn
      Export:
        Name: ${self:service}-SqsClArn

    AppointmentsTopicArn:
      Value: !Ref AppointmentsTopic
      Export:
        Name: ${self:service}-AppointmentsTopicArn

    SqsReturnArn:
      Value: !GetAtt SqsReturn.Arn
      Export:
        Name: ${self:service}-SqsReturnArn

functions:
  hello:
    handler: src/handler.hello
    events:
      - httpApi:
          path: /
          method: get

# Build nativo en Serverless v4 (reemplaza serverless-esbuild)
build:
  esbuild: true
  minify: false
  sourcemap: true
  target: node20
  platform: node

plugins:
  - serverless-offline
